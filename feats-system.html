<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RulzLawyer - Feats System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #8B4513;
            --secondary-color: #DAA520;
            --accent-color: #CD853F;
            --text-light: #F5E6D3;
            --text-dark: #2F1B14;
            --background-dark: #1a0f0a;
            --card-background: #2F1B14;
            --border-color: #4A2C2A;
            --success-color: #228B22;
            --warning-color: #FF8C00;
            --error-color: #DC143C;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, var(--background-dark) 0%, #2F1B14 100%);
            color: var(--text-light);
            min-height: 100vh;
            background-attachment: fixed;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(139, 69, 19, 0.3);
            border-radius: 15px;
            border: 2px solid var(--border-color);
        }

        .header h1 {
            font-size: 2.8rem;
            color: var(--secondary-color);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            color: var(--text-light);
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .sidebar {
            background: var(--card-background);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .content-area {
            background: var(--card-background);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .search-section {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: var(--text-light);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .search-input:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 10px rgba(218, 165, 32, 0.3);
        }

        .filters {
            margin-bottom: 20px;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .filter-select {
            width: 100%;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            background: rgba(0,0,0,0.3);
            color: var(--text-light);
            font-size: 14px;
        }

        .feat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .feat-card {
            background: rgba(0,0,0,0.2);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .feat-card:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 5px 15px rgba(218, 165, 32, 0.2);
            transform: translateY(-2px);
        }

        .feat-card.available {
            border-color: var(--success-color);
        }

        .feat-card.unavailable {
            border-color: var(--error-color);
            opacity: 0.6;
        }

        .feat-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--secondary-color);
            margin-bottom: 8px;
        }

        .feat-type {
            display: inline-block;
            padding: 4px 12px;
            background: var(--accent-color);
            color: white;
            border-radius: 15px;
            font-size: 0.8rem;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .feat-description {
            font-size: 0.95rem;
            line-height: 1.4;
            margin-bottom: 12px;
            color: var(--text-light);
        }

        .feat-benefit {
            font-size: 0.9rem;
            color: var(--success-color);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .prerequisites {
            margin-top: 10px;
            padding: 10px;
            background: rgba(220, 20, 60, 0.1);
            border-left: 4px solid var(--error-color);
            border-radius: 5px;
        }

        .prerequisites h4 {
            color: var(--error-color);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .prerequisite-list {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .feat-effects {
            margin-top: 10px;
            padding: 10px;
            background: rgba(34, 139, 34, 0.1);
            border-left: 4px solid var(--success-color);
            border-radius: 5px;
        }

        .feat-effects h4 {
            color: var(--success-color);
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .effects-list {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .selected-feat {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-background);
            border: 3px solid var(--secondary-color);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 20px 40px rgba(0,0,0,0.8);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 999;
        }

        .close-button {
            float: right;
            background: var(--error-color);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }

        .action-button {
            background: var(--secondary-color);
            color: var(--text-dark);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px 0 0;
            transition: all 0.3s ease;
        }

        .action-button:hover {
            background: var(--accent-color);
            transform: translateY(-1px);
        }

        .action-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .stats-panel {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .navigation {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
        }

        .nav-button {
            display: inline-block;
            background: var(--primary-color);
            color: var(--text-light);
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 8px;
            margin: 0 10px;
            transition: all 0.3s ease;
            border: 2px solid var(--border-color);
        }

        .nav-button:hover {
            background: var(--secondary-color);
            color: var(--text-dark);
            border-color: var(--secondary-color);
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: var(--secondary-color);
        }

        .error-message {
            background: rgba(220, 20, 60, 0.1);
            border: 1px solid var(--error-color);
            color: var(--error-color);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
                margin-bottom: 20px;
            }
            
            .feat-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚔️ Feats System</h1>
            <p>D&D 3.5 Complete Feats Database - Enhance Your Character's Abilities</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="stats-panel">
                    <h3>📊 System Stats</h3>
                    <div class="stat-row">
                        <span>Total Feats:</span>
                        <span id="total-feats">Loading...</span>
                    </div>
                    <div class="stat-row">
                        <span>Available:</span>
                        <span id="available-feats">0</span>
                    </div>
                    <div class="stat-row">
                        <span>Character Feats:</span>
                        <span id="character-feats">0</span>
                    </div>
                </div>

                <div class="search-section">
                    <h3>🔍 Search Feats</h3>
                    <input type="text" id="search-input" class="search-input" placeholder="Search feats...">
                </div>

                <div class="filters">
                    <h3>🎯 Filters</h3>
                    <div class="filter-group">
                        <label class="filter-label">Feat Type:</label>
                        <select id="type-filter" class="filter-select">
                            <option value="">All Types</option>
                            <option value="general">General</option>
                            <option value="combat">Combat</option>
                            <option value="metamagic">Metamagic</option>
                            <option value="itemCreation">Item Creation</option>
                            <option value="skill">Skill</option>
                            <option value="racial">Racial</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Availability:</label>
                        <select id="availability-filter" class="filter-select">
                            <option value="">All Feats</option>
                            <option value="available">Available Only</option>
                            <option value="unavailable">Prerequisites Not Met</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Class Requirements:</label>
                        <select id="class-filter" class="filter-select">
                            <option value="">All Classes</option>
                            <option value="fighter">Fighter</option>
                            <option value="wizard">Wizard</option>
                            <option value="cleric">Cleric</option>
                            <option value="none">No Class Requirement</option>
                        </select>
                    </div>
                </div>

                <div class="filter-group">
                    <button id="reset-filters" class="action-button">Reset Filters</button>
                </div>
            </div>

            <div class="content-area">
                <div id="loading" class="loading">
                    🎲 Loading Feats System...
                </div>

                <div id="error-container"></div>

                <div id="feats-grid" class="feat-grid" style="display: none;">
                    <!-- Feats will be loaded here -->
                </div>
            </div>
        </div>

        <div class="navigation">
            <a href="character-creation.html" class="nav-button">👤 Character Creation</a>
            <a href="equipment.html" class="nav-button">⚔️ Equipment</a>
            <a href="spells.html" class="nav-button">📚 Spells</a>
            <a href="index.html" class="nav-button">🏠 Home</a>
        </div>
    </div>

    <!-- Modal for feat details -->
    <div id="feat-modal" style="display: none;">
        <div class="modal-overlay" onclick="closeFeatModal()"></div>
        <div class="selected-feat">
            <button class="close-button" onclick="closeFeatModal()">&times;</button>
            <div id="feat-details">
                <!-- Feat details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Include core scripts -->
    <script src="app.js"></script>
    <script src="code-repository/src/dice-engine.js"></script>
    <script src="code-repository/src/character-data-model.js"></script>
    <script src="code-repository/src/feats-system.js"></script>

    <script>
        // === Global Variables ===
        let gameEngine = null;
        let featsSystem = null;
        let currentCharacter = null;
        let filteredFeats = [];
        let allFeats = [];

        // === Initialization ===
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('🎲 Initializing Feats System Interface...');
                
                // Initialize game engine
                gameEngine = new RulzLawyerGameEngine();
                await gameEngine.initialize();
                
                // Get systems
                featsSystem = gameEngine.featsSystem;
                
                if (!featsSystem) {
                    throw new Error('Feats System not available');
                }

                // Load mock character for testing
                currentCharacter = createMockCharacter();
                
                // Load feats data
                await loadFeatsData();
                
                // Setup event listeners
                setupEventListeners();
                
                // Initial display
                displayFeats();
                updateStats();
                
                console.log('✅ Feats System Interface ready');
                
            } catch (error) {
                console.error('❌ Failed to initialize:', error);
                showError('Failed to initialize Feats System: ' + error.message);
            }
        });

        // === Mock Character for Testing ===
        function createMockCharacter() {
            return {
                name: 'Test Character',
                race: 'Human',
                classes: [
                    { name: 'Fighter', level: 5 }
                ],
                abilities: {
                    Strength: 16,
                    Dexterity: 14,
                    Constitution: 15,
                    Intelligence: 12,
                    Wisdom: 13,
                    Charisma: 10
                },
                skills: {
                    Climb: { ranks: 5 },
                    Jump: { ranks: 3 },
                    Intimidate: { ranks: 8 }
                },
                feats: ['power_attack', 'weapon_focus'],
                baseAttackBonus: 5
            };
        }

        // === Data Loading ===
        async function loadFeatsData() {
            try {
                // Get all feats
                const featTypes = ['general', 'combat', 'metamagic', 'itemCreation', 'skill'];
                allFeats = [];
                
                for (const type of featTypes) {
                    const typeFeats = featsSystem.getFeatsByType(type);
                    allFeats.push(...typeFeats);
                }
                
                // Add feat availability information
                for (const feat of allFeats) {
                    const validation = featsSystem.validatePrerequisites(feat.id, currentCharacter);
                    feat.available = validation.valid;
                    feat.prerequisiteReasons = validation.reasons;
                }
                
                filteredFeats = [...allFeats];
                
                console.log(`📚 Loaded ${allFeats.length} feats`);
                
            } catch (error) {
                console.error('❌ Error loading feats:', error);
                throw error;
            }
        }

        // === Event Listeners ===
        function setupEventListeners() {
            const searchInput = document.getElementById('search-input');
            const typeFilter = document.getElementById('type-filter');
            const availabilityFilter = document.getElementById('availability-filter');
            const classFilter = document.getElementById('class-filter');
            const resetButton = document.getElementById('reset-filters');

            searchInput.addEventListener('input', applyFilters);
            typeFilter.addEventListener('change', applyFilters);
            availabilityFilter.addEventListener('change', applyFilters);
            classFilter.addEventListener('change', applyFilters);
            resetButton.addEventListener('click', resetFilters);
        }

        // === Filtering ===
        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const typeFilter = document.getElementById('type-filter').value;
            const availabilityFilter = document.getElementById('availability-filter').value;
            const classFilter = document.getElementById('class-filter').value;

            filteredFeats = allFeats.filter(feat => {
                // Search filter
                if (searchTerm && !feat.name.toLowerCase().includes(searchTerm) && 
                    !feat.description.toLowerCase().includes(searchTerm)) {
                    return false;
                }

                // Type filter
                if (typeFilter && feat.type !== typeFilter) {
                    return false;
                }

                // Availability filter
                if (availabilityFilter === 'available' && !feat.available) {
                    return false;
                }
                if (availabilityFilter === 'unavailable' && feat.available) {
                    return false;
                }

                // Class filter
                if (classFilter) {
                    if (classFilter === 'none') {
                        if (feat.prerequisites.classes) {
                            return false;
                        }
                    } else {
                        if (!feat.prerequisites.classes || 
                            !feat.prerequisites.classes.includes(classFilter)) {
                            return false;
                        }
                    }
                }

                return true;
            });

            displayFeats();
            updateStats();
        }

        function resetFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('type-filter').value = '';
            document.getElementById('availability-filter').value = '';
            document.getElementById('class-filter').value = '';
            
            filteredFeats = [...allFeats];
            displayFeats();
            updateStats();
        }

        // === Display Functions ===
        function displayFeats() {
            const featsGrid = document.getElementById('feats-grid');
            const loadingDiv = document.getElementById('loading');
            
            if (filteredFeats.length === 0 && allFeats.length > 0) {
                featsGrid.innerHTML = '<div class="no-results">No feats match the current filters.</div>';
                featsGrid.style.display = 'block';
                loadingDiv.style.display = 'none';
                return;
            }
            
            const featsHtml = filteredFeats.map(feat => createFeatCard(feat)).join('');
            featsGrid.innerHTML = featsHtml;
            featsGrid.style.display = 'grid';
            loadingDiv.style.display = 'none';
        }

        function createFeatCard(feat) {
            const availabilityClass = feat.available ? 'available' : 'unavailable';
            
            return `
                <div class="feat-card ${availabilityClass}" onclick="showFeatDetails('${feat.id}')">
                    <div class="feat-name">${feat.name}</div>
                    <div class="feat-type">${feat.type}</div>
                    <div class="feat-description">${feat.description}</div>
                    <div class="feat-benefit"><strong>Benefit:</strong> ${feat.benefit}</div>
                    
                    ${createPrerequisitesHtml(feat)}
                    ${createEffectsHtml(feat)}
                    
                    <div style="margin-top: 15px;">
                        <button class="action-button ${feat.available ? '' : 'disabled'}" 
                                ${feat.available ? '' : 'disabled'}
                                onclick="event.stopPropagation(); selectFeat('${feat.id}')">
                            ${feat.available ? 'Select Feat' : 'Prerequisites Not Met'}
                        </button>
                    </div>
                </div>
            `;
        }

        function createPrerequisitesHtml(feat) {
            if (!feat.prerequisites || Object.keys(feat.prerequisites).length === 0) {
                return '';
            }

            const prereqList = [];
            
            if (feat.prerequisites.abilities) {
                for (const [ability, value] of Object.entries(feat.prerequisites.abilities)) {
                    if (ability === 'baseAttackBonus') {
                        prereqList.push(`Base Attack Bonus +${value}`);
                    } else {
                        prereqList.push(`${ability} ${value}`);
                    }
                }
            }
            
            if (feat.prerequisites.feats) {
                prereqList.push(...feat.prerequisites.feats);
            }
            
            if (feat.prerequisites.skills) {
                for (const [skill, ranks] of Object.entries(feat.prerequisites.skills)) {
                    prereqList.push(`${skill} ${ranks} ranks`);
                }
            }
            
            if (feat.prerequisites.race) {
                prereqList.push(`Race: ${feat.prerequisites.race}`);
            }
            
            if (feat.prerequisites.classes) {
                prereqList.push(`Class: ${feat.prerequisites.classes.join(' or ')}`);
            }

            if (prereqList.length === 0) return '';

            return `
                <div class="prerequisites">
                    <h4>📋 Prerequisites:</h4>
                    <div class="prerequisite-list">${prereqList.join(', ')}</div>
                </div>
            `;
        }

        function createEffectsHtml(feat) {
            if (!feat.effects || Object.keys(feat.effects).length === 0) {
                return '';
            }

            const effectsList = [];
            
            if (feat.effects.skills) {
                for (const [skill, bonus] of Object.entries(feat.effects.skills)) {
                    effectsList.push(`+${bonus} ${skill}`);
                }
            }
            
            if (feat.effects.saves) {
                for (const [save, bonus] of Object.entries(feat.effects.saves)) {
                    effectsList.push(`+${bonus} ${save} saves`);
                }
            }
            
            if (feat.effects.combat) {
                const combat = feat.effects.combat;
                if (combat.initiative) effectsList.push(`+${combat.initiative} Initiative`);
                if (combat.dodgeBonus) effectsList.push(`+${combat.dodgeBonus} dodge bonus to AC`);
                if (combat.additionalAoO) effectsList.push('Additional attacks of opportunity');
            }
            
            if (feat.effects.hitPoints) {
                if (feat.effects.hitPoints.bonus) {
                    effectsList.push(`+${feat.effects.hitPoints.bonus} hit points`);
                }
            }

            if (effectsList.length === 0) return '';

            return `
                <div class="feat-effects">
                    <h4>✨ Effects:</h4>
                    <div class="effects-list">${effectsList.join(', ')}</div>
                </div>
            `;
        }

        function updateStats() {
            document.getElementById('total-feats').textContent = allFeats.length;
            document.getElementById('available-feats').textContent = allFeats.filter(f => f.available).length;
            document.getElementById('character-feats').textContent = currentCharacter.feats ? currentCharacter.feats.length : 0;
        }

        // === Modal Functions ===
        function showFeatDetails(featId) {
            const feat = allFeats.find(f => f.id === featId);
            if (!feat) return;

            const modal = document.getElementById('feat-modal');
            const details = document.getElementById('feat-details');
            
            details.innerHTML = `
                <h2>${feat.name}</h2>
                <div class="feat-type">${feat.type}</div>
                <div style="margin: 20px 0;">
                    <strong>Description:</strong><br>
                    ${feat.description}
                </div>
                <div style="margin: 20px 0;">
                    <strong>Benefit:</strong><br>
                    ${feat.benefit}
                </div>
                ${createPrerequisitesHtml(feat)}
                ${createEffectsHtml(feat)}
                <div style="margin-top: 20px;">
                    <button class="action-button ${feat.available ? '' : 'disabled'}" 
                            ${feat.available ? '' : 'disabled'}
                            onclick="selectFeat('${feat.id}'); closeFeatModal();">
                        ${feat.available ? 'Select This Feat' : 'Prerequisites Not Met'}
                    </button>
                    ${feat.prerequisiteReasons && feat.prerequisiteReasons.length > 0 ? 
                        `<div style="margin-top: 10px; color: var(--error-color); font-size: 0.9rem;">
                            Missing: ${feat.prerequisiteReasons.join(', ')}
                        </div>` : ''}
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeFeatModal() {
            document.getElementById('feat-modal').style.display = 'none';
        }

        function selectFeat(featId) {
            const feat = allFeats.find(f => f.id === featId);
            if (!feat || !feat.available) return;

            // Add feat to character
            if (!currentCharacter.feats) {
                currentCharacter.feats = [];
            }
            
            if (!currentCharacter.feats.includes(featId)) {
                currentCharacter.feats.push(featId);
                
                // Apply feat effects
                featsSystem.applyFeatEffects(currentCharacter, featId);
                
                alert(`✅ ${feat.name} selected! The feat has been added to your character.`);
                
                // Refresh display
                loadFeatsData().then(() => {
                    displayFeats();
                    updateStats();
                });
            } else {
                alert(`⚠️ You already have the ${feat.name} feat.`);
            }
        }

        // === Utility Functions ===
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `
                <div class="error-message">
                    <strong>❌ Error:</strong> ${message}
                </div>
            `;
            document.getElementById('loading').style.display = 'none';
        }

        // Export for testing
        window.featsInterface = {
            gameEngine,
            featsSystem,
            currentCharacter,
            loadFeatsData,
            displayFeats,
            selectFeat
        };
    </script>
</body>
</html>