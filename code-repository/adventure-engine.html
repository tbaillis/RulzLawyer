<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventure Engine - RulzLawyer D&D 3.5</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c1810, #4a2c20, #3d2317);
            color: #f4f1e8;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(139, 69, 19, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(184, 134, 11, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.3), rgba(160, 82, 45, 0.2));
            border: 2px solid #8b4513;
            border-radius: 15px;
            position: relative;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .header::before {
            content: 'üó∫Ô∏è';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2em;
            background: linear-gradient(135deg, #2c1810, #4a2c20);
            padding: 10px;
            border-radius: 50%;
            border: 2px solid #8b4513;
        }

        h1 {
            color: #daa520;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin: 10px 0;
        }

        .subtitle {
            color: #f4f1e8;
            font-size: 1.2em;
            opacity: 0.9;
        }

        .navigation {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-button {
            display: inline-block;
            margin: 0 10px;
            padding: 12px 25px;
            background: linear-gradient(135deg, #8b4513, #a0522d);
            color: #f4f1e8;
            text-decoration: none;
            border-radius: 8px;
            border: 1px solid #654321;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .nav-button:hover {
            background: linear-gradient(135deg, #a0522d, #cd853f);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            transform: translateY(-2px);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .control-panel {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.2), rgba(160, 82, 45, 0.1));
            border: 2px solid #8b4513;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .control-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(44, 24, 16, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(139, 69, 19, 0.3);
        }

        .control-section h3 {
            color: #daa520;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #f4f1e8;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            background: rgba(44, 24, 16, 0.7);
            border: 1px solid #8b4513;
            border-radius: 6px;
            color: #f4f1e8;
            font-size: 16px;
        }

        .form-control:focus {
            outline: none;
            border-color: #daa520;
            box-shadow: 0 0 5px rgba(218, 165, 32, 0.3);
        }

        select.form-control option {
            background: #2c1810;
            color: #f4f1e8;
        }

        .generate-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #228b22, #32cd32);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin: 10px 0;
        }

        .generate-button:hover {
            background: linear-gradient(135deg, #32cd32, #90ee90);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            transform: translateY(-2px);
        }

        .generate-button:active {
            transform: translateY(0);
        }

        .quick-generate {
            background: linear-gradient(135deg, #ff6347, #ff4500);
        }

        .quick-generate:hover {
            background: linear-gradient(135deg, #ff4500, #ff8c00);
        }

        .result-panel {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.2), rgba(160, 82, 45, 0.1));
            border: 2px solid #8b4513;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(139, 69, 19, 0.3);
        }

        .result-title {
            color: #daa520;
            font-size: 1.5em;
            margin: 0;
        }

        .result-actions {
            display: flex;
            gap: 10px;
        }

        .action-button {
            padding: 8px 15px;
            background: linear-gradient(135deg, #4169e1, #6495ed);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .action-button:hover {
            background: linear-gradient(135deg, #6495ed, #87ceeb);
            transform: translateY(-1px);
        }

        .adventure-content {
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            background: rgba(44, 24, 16, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(139, 69, 19, 0.3);
        }

        .adventure-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(139, 69, 19, 0.1);
            border-radius: 8px;
            border-left: 4px solid #daa520;
        }

        .adventure-section h4 {
            color: #daa520;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .adventure-section p, .adventure-section ul {
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .adventure-section ul {
            padding-left: 20px;
        }

        .encounter-card {
            background: rgba(44, 24, 16, 0.4);
            border: 1px solid #8b4513;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .encounter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .encounter-type {
            background: linear-gradient(135deg, #dc143c, #b22222);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .encounter-difficulty {
            background: linear-gradient(135deg, #ffa500, #ff8c00);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .npc-card {
            background: rgba(44, 24, 16, 0.4);
            border: 1px solid #8b4513;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #4169e1;
        }

        .treasure-card {
            background: rgba(44, 24, 16, 0.4);
            border: 1px solid #8b4513;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #ffd700;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(139, 69, 19, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(139, 69, 19, 0.3);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #daa520;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #daa520;
            font-size: 1.2em;
        }

        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: linear-gradient(135deg, rgba(220, 20, 60, 0.2), rgba(178, 34, 34, 0.1));
            border: 1px solid #dc143c;
            border-radius: 8px;
            padding: 15px;
            color: #ffcccb;
            margin: 10px 0;
        }

        .success {
            background: linear-gradient(135deg, rgba(34, 139, 34, 0.2), rgba(50, 205, 50, 0.1));
            border: 1px solid #228b22;
            border-radius: 8px;
            padding: 15px;
            color: #90ee90;
            margin: 10px 0;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid rgba(139, 69, 19, 0.3);
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(139, 69, 19, 0.2);
            border: 1px solid rgba(139, 69, 19, 0.3);
            border-bottom: none;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px 8px 0 0;
        }

        .tab.active {
            background: rgba(218, 165, 32, 0.2);
            color: #daa520;
            border-color: #daa520;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .container {
                padding: 10px;
            }

            h1 {
                font-size: 2em;
            }

            .nav-button {
                display: block;
                margin: 5px 0;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            opacity: 0.7;
            border-top: 1px solid rgba(139, 69, 19, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Adventure Engine</h1>
            <div class="subtitle">Complete D&D 3.5 Adventure Generation System</div>
        </div>

        <div class="navigation">
            <a href="index.html" class="nav-button">üè† Home</a>
            <a href="character-creator.html" class="nav-button">üë§ Character Creator</a>
            <a href="random-tables.html" class="nav-button">üé≤ Random Tables</a>
            <a href="dice-roller.html" class="nav-button">‚öÑ Dice Roller</a>
        </div>

        <div class="main-grid">
            <div class="control-panel">
                <div class="control-section">
                    <h3>üéØ Adventure Parameters</h3>
                    
                    <div class="form-group">
                        <label for="partyLevel">Party Level:</label>
                        <select id="partyLevel" class="form-control">
                            <option value="1">Level 1</option>
                            <option value="2">Level 2</option>
                            <option value="3" selected>Level 3</option>
                            <option value="4">Level 4</option>
                            <option value="5">Level 5</option>
                            <option value="6">Level 6</option>
                            <option value="7">Level 7</option>
                            <option value="8">Level 8</option>
                            <option value="9">Level 9</option>
                            <option value="10">Level 10</option>
                            <option value="11">Level 11</option>
                            <option value="12">Level 12</option>
                            <option value="13">Level 13</option>
                            <option value="14">Level 14</option>
                            <option value="15">Level 15</option>
                            <option value="16">Level 16</option>
                            <option value="17">Level 17</option>
                            <option value="18">Level 18</option>
                            <option value="19">Level 19</option>
                            <option value="20">Level 20</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="partySize">Party Size:</label>
                        <select id="partySize" class="form-control">
                            <option value="2">2 Characters</option>
                            <option value="3">3 Characters</option>
                            <option value="4" selected>4 Characters</option>
                            <option value="5">5 Characters</option>
                            <option value="6">6 Characters</option>
                            <option value="7">7 Characters</option>
                            <option value="8">8 Characters</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="adventureType">Adventure Type:</label>
                        <select id="adventureType" class="form-control">
                            <option value="">Random</option>
                            <option value="investigation">Investigation</option>
                            <option value="dungeon">Dungeon Delve</option>
                            <option value="rescue">Rescue Mission</option>
                            <option value="exploration">Exploration</option>
                            <option value="political">Political Intrigue</option>
                            <option value="escort">Escort Mission</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="difficulty">Difficulty:</label>
                        <select id="difficulty" class="form-control">
                            <option value="easy">Easy</option>
                            <option value="medium" selected>Medium</option>
                            <option value="hard">Hard</option>
                            <option value="deadly">Deadly</option>
                        </select>
                    </div>
                </div>

                <div class="control-section">
                    <h3>‚öôÔ∏è Options</h3>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="includeDungeon"> Include Dungeon
                        </label>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="includeWeather" checked> Include Weather
                        </label>
                    </div>

                    <div class="form-group">
                        <label for="duration">Adventure Duration:</label>
                        <select id="duration" class="form-control">
                            <option value="1">One Shot (1 session)</option>
                            <option value="3" selected>Short (2-3 sessions)</option>
                            <option value="6">Medium (4-6 sessions)</option>
                            <option value="10">Long (7-10 sessions)</option>
                        </select>
                    </div>
                </div>

                <button onclick="generateAdventure()" class="generate-button">
                    üó∫Ô∏è Generate Complete Adventure
                </button>

                <button onclick="generateQuickAdventure()" class="generate-button quick-generate">
                    ‚ö° Quick Adventure
                </button>

                <button onclick="generateEncounter()" class="generate-button">
                    ‚öîÔ∏è Single Encounter
                </button>
            </div>

            <div class="result-panel">
                <div class="result-header">
                    <h3 class="result-title">Adventure Results</h3>
                    <div class="result-actions">
                        <button onclick="exportAdventure()" class="action-button">üìÑ Export</button>
                        <button onclick="saveAdventure()" class="action-button">üíæ Save</button>
                        <button onclick="clearResults()" class="action-button">üóëÔ∏è Clear</button>
                    </div>
                </div>

                <div id="adventureResults" class="adventure-content">
                    <div class="loading" style="display: none;" id="loadingIndicator">
                        Generating Adventure
                    </div>
                    
                    <div id="welcomeMessage">
                        <div class="adventure-section">
                            <h4>üé≤ Welcome to the Adventure Engine!</h4>
                            <p>Create complete D&D 3.5 adventures with balanced encounters, engaging storylines, and comprehensive details.</p>
                            
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-value" id="adventuresGenerated">0</div>
                                    <div class="stat-label">Adventures Generated</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">17+</div>
                                    <div class="stat-label">Adventure Types</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">CR 1-20</div>
                                    <div class="stat-label">Challenge Range</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value">‚àû</div>
                                    <div class="stat-label">Possibilities</div>
                                </div>
                            </div>

                            <h4>üåü Features:</h4>
                            <ul>
                                <li><strong>Balanced Encounters:</strong> CR-appropriate challenges for any party</li>
                                <li><strong>Complete Stories:</strong> Hooks, NPCs, and plot development</li>
                                <li><strong>Treasure Systems:</strong> Level-appropriate rewards and magic items</li>
                                <li><strong>Dungeon Generation:</strong> Interconnected rooms with features</li>
                                <li><strong>Weather & Environment:</strong> Dynamic world conditions</li>
                                <li><strong>Campaign Tools:</strong> Timeline and story progression</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>RulzLawyer D&D 3.5 Adventure Engine | Generate epic adventures with the power of AI</p>
        </div>
    </div>

    <script src="src/dice-engine.js"></script>
    <script src="src/character-data-model.js"></script>
    <script src="src/storage-manager.js"></script>
    <script src="src/character-manager.js"></script>
    <script src="src/random-tables-engine.js"></script>
    <script src="src/adventure-engine.js"></script>
    <script src="../app.js"></script>

    <script>
        // Adventure Engine Interface Controller
        let currentAdventure = null;
        let adventureStats = {
            generated: 0,
            lastGenerated: null
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üó∫Ô∏è  Initializing Adventure Engine Interface...');
            
            // Wait for game engine to be ready
            setTimeout(() => {
                if (window.adventureEngine) {
                    updateStatistics();
                    console.log('‚úÖ Adventure Engine Interface ready');
                } else {
                    console.warn('‚ö†Ô∏è  Adventure Engine not found, using fallback mode');
                    initializeFallbackMode();
                }
            }, 1000);
        });

        // === Main Generation Functions ===
        async function generateAdventure() {
            try {
                showLoading(true);
                clearMessages();

                const parameters = gatherParameters();
                console.log('üéØ Generating adventure with parameters:', parameters);

                let adventure;
                if (window.adventureEngine) {
                    adventure = window.adventureEngine.generateAdventure(parameters);
                } else {
                    adventure = generateFallbackAdventure(parameters);
                }

                currentAdventure = adventure;
                displayAdventure(adventure);
                updateStatistics();
                
                showSuccess('Adventure generated successfully!');
                console.log('‚úÖ Adventure generated:', adventure.title);

            } catch (error) {
                console.error('‚ùå Adventure generation failed:', error);
                showError('Failed to generate adventure: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function generateQuickAdventure() {
            try {
                showLoading(true);
                clearMessages();

                const partyLevel = parseInt(document.getElementById('partyLevel').value) || 3;
                const partySize = parseInt(document.getElementById('partySize').value) || 4;

                let adventure;
                if (window.adventureEngine) {
                    adventure = window.adventureEngine.generateQuickAdventure(partyLevel, partySize);
                } else {
                    adventure = generateFallbackAdventure({ partyLevel, partySize, quick: true });
                }

                currentAdventure = adventure;
                displayAdventure(adventure);
                updateStatistics();
                
                showSuccess('Quick adventure generated!');
                console.log('‚ö° Quick adventure generated:', adventure.title);

            } catch (error) {
                console.error('‚ùå Quick adventure generation failed:', error);
                showError('Failed to generate quick adventure: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function generateEncounter() {
            try {
                showLoading(true);
                clearMessages();

                const parameters = gatherParameters();
                console.log('‚öîÔ∏è  Generating encounter with parameters:', parameters);

                let encounter;
                if (window.adventureEngine) {
                    encounter = window.adventureEngine.generateEncounterOnly(parameters);
                } else {
                    encounter = generateFallbackEncounter(parameters);
                }

                displayEncounterOnly(encounter);
                
                showSuccess('Encounter generated successfully!');
                console.log('‚öîÔ∏è  Encounter generated:', encounter.title);

            } catch (error) {
                console.error('‚ùå Encounter generation failed:', error);
                showError('Failed to generate encounter: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // === Parameter Gathering ===
        function gatherParameters() {
            return {
                partyLevel: parseInt(document.getElementById('partyLevel').value) || 3,
                partySize: parseInt(document.getElementById('partySize').value) || 4,
                type: document.getElementById('adventureType').value || null,
                difficulty: document.getElementById('difficulty').value || 'medium',
                includeDungeon: document.getElementById('includeDungeon').checked,
                includeWeather: document.getElementById('includeWeather').checked,
                adventureDuration: parseInt(document.getElementById('duration').value) || 3
            };
        }

        // === Display Functions ===
        function displayAdventure(adventure) {
            const resultsDiv = document.getElementById('adventureResults');
            
            const html = `
                <div class="adventure-section">
                    <h4>üéØ ${adventure.title}</h4>
                    <p><strong>Type:</strong> ${adventure.type}</p>
                    <p><strong>Party Level:</strong> ${adventure.partyLevel} | <strong>Party Size:</strong> ${adventure.partySize}</p>
                    <p><strong>Difficulty:</strong> ${adventure.difficulty} | <strong>Duration:</strong> ${adventure.estimatedDuration ? adventure.estimatedDuration.sessions : 3} sessions</p>
                </div>

                ${adventure.hook ? displayAdventureHook(adventure.hook) : ''}
                ${adventure.setting ? displaySetting(adventure.setting) : ''}
                ${adventure.npcs ? displayNPCs(adventure.npcs) : ''}
                ${adventure.encounters ? displayEncounters(adventure.encounters) : ''}
                ${adventure.treasures ? displayTreasures(adventure.treasures) : ''}
                ${adventure.dungeon ? displayDungeon(adventure.dungeon) : ''}
                ${adventure.weather ? displayWeather(adventure.weather) : ''}
                ${adventure.rewards ? displayRewards(adventure.rewards) : ''}
                ${adventure.timeline ? displayTimeline(adventure.timeline) : ''}
            `;

            resultsDiv.innerHTML = html;
        }

        function displayAdventureHook(hook) {
            const patronInfo = hook.patron ? `
                <p><strong>Patron:</strong> ${hook.patron.name} (${hook.patron.type})</p>
                <p><strong>Motivation:</strong> ${hook.patron.motivation}</p>
                <p><strong>Reward Offered:</strong> ${hook.reward}</p>
            ` : '';

            return `
                <div class="adventure-section">
                    <h4>üéØ Adventure Hook</h4>
                    <p><strong>Plot Hook:</strong> ${hook.text || hook.description || 'Mystery awaits...'}</p>
                    <p><strong>Urgency:</strong> ${hook.urgency || 'Moderate'}</p>
                    ${patronInfo}
                    ${hook.complications && hook.complications.length > 0 ? `<p><strong>Complications:</strong> ${hook.complications.join(', ')}</p>` : ''}
                </div>
            `;
        }

        function displaySetting(setting) {
            return `
                <div class="adventure-section">
                    <h4>üèûÔ∏è Setting</h4>
                    <p><strong>Primary Location:</strong> ${setting.primaryLocation?.text || 'Unknown location'}</p>
                    <p><strong>Terrain:</strong> ${setting.terrain?.text || 'Varied terrain'}</p>
                    <p><strong>Climate:</strong> ${setting.climate || 'Temperate'}</p>
                    ${setting.secondaryLocations && setting.secondaryLocations.length > 0 ? `
                        <p><strong>Secondary Locations:</strong></p>
                        <ul>
                            ${setting.secondaryLocations.map(loc => `
                                <li>${loc.text} - ${loc.distance} away (${loc.travelTime})</li>
                            `).join('')}
                        </ul>
                    ` : ''}
                </div>
            `;
        }

        function displayNPCs(npcs) {
            if (!npcs || npcs.length === 0) return '';
            
            const npcCards = npcs.map(npc => `
                <div class="npc-card">
                    <h5>${npc.name?.fullName || npc.name || 'Unnamed NPC'}</h5>
                    <p><strong>Role:</strong> ${npc.role || 'Background character'}</p>
                    <p><strong>Location:</strong> ${npc.location || 'Various locations'}</p>
                    ${npc.personality?.text ? `<p><strong>Personality:</strong> ${npc.personality.text}</p>` : ''}
                    ${npc.motivation?.text ? `<p><strong>Motivation:</strong> ${npc.motivation.text}</p>` : ''}
                    ${npc.secrets ? `<p><strong>Secret:</strong> ${npc.secrets}</p>` : ''}
                </div>
            `).join('');

            return `
                <div class="adventure-section">
                    <h4>üë• Important NPCs</h4>
                    ${npcCards}
                </div>
            `;
        }

        function displayEncounters(encounters) {
            if (!encounters || encounters.length === 0) return '';
            
            const encounterCards = encounters.map((encounter, index) => `
                <div class="encounter-card">
                    <div class="encounter-header">
                        <h5>Encounter ${index + 1}: ${encounter.type}</h5>
                        <div>
                            <span class="encounter-type">${encounter.type}</span>
                            <span class="encounter-difficulty">${encounter.difficulty}</span>
                        </div>
                    </div>
                    <p><strong>Location:</strong> ${encounter.location || 'Unspecified'}</p>
                    <p><strong>Trigger:</strong> ${encounter.trigger || 'Party encounters'}</p>
                    
                    ${encounter.details ? displayEncounterDetails(encounter.details, encounter.type) : ''}
                </div>
            `).join('');

            return `
                <div class="adventure-section">
                    <h4>‚öîÔ∏è Encounters</h4>
                    ${encounterCards}
                </div>
            `;
        }

        function displayEncounterDetails(details, type) {
            switch (type) {
                case 'combat':
                    return details.creatures ? `
                        <p><strong>Creatures:</strong></p>
                        <ul>
                            ${details.creatures.map(c => `
                                <li>${c.quantity}x ${c.name} (CR ${c.cr}, ${c.xp} XP each)</li>
                            `).join('')}
                        </ul>
                        <p><strong>Total XP:</strong> ${details.totalXP || 0}</p>
                        ${details.terrain ? `<p><strong>Terrain:</strong> ${details.terrain.type || details.terrain}</p>` : ''}
                    ` : '<p>Combat encounter details not available</p>';
                
                case 'social':
                    return `
                        <p><strong>Objective:</strong> ${details.objective || 'Social interaction'}</p>
                        <p><strong>NPC Attitude:</strong> ${details.attitude || 'Neutral'}</p>
                        ${details.skills ? `<p><strong>Useful Skills:</strong> ${details.skills.join(', ')}</p>` : ''}
                        ${details.information ? `<p><strong>Information Available:</strong> ${details.information}</p>` : ''}
                    `;
                
                default:
                    return `<p><strong>Details:</strong> ${details.description || details.type || 'Encounter details'}</p>`;
            }
        }

        function displayTreasures(treasures) {
            if (!treasures || treasures.length === 0) return '';
            
            const treasureCards = treasures.map((treasure, index) => `
                <div class="treasure-card">
                    <h5>Treasure ${index + 1}</h5>
                    <p><strong>Contents:</strong> ${treasure.text || treasure.description || 'Valuable items'}</p>
                    <p><strong>Location:</strong> ${treasure.location || 'Hidden'}</p>
                    <p><strong>Protection:</strong> ${treasure.protection || 'Unguarded'}</p>
                    <p><strong>Discovery:</strong> ${treasure.discovery || 'Obvious'}</p>
                </div>
            `).join('');

            return `
                <div class="adventure-section">
                    <h4>üí∞ Treasures</h4>
                    ${treasureCards}
                </div>
            `;
        }

        function displayDungeon(dungeon) {
            if (!dungeon) return '';
            
            const roomList = dungeon.rooms ? dungeon.rooms.map((room, index) => `
                <li><strong>${room.name || `Room ${index + 1}`}:</strong> ${room.text || room.contents || 'Empty chamber'}</li>
            `).join('') : '';

            return `
                <div class="adventure-section">
                    <h4>üè∞ Dungeon: ${dungeon.name}</h4>
                    <p><strong>Theme:</strong> ${dungeon.theme || 'Ancient ruins'}</p>
                    <p><strong>Size:</strong> ${dungeon.size || 'Medium'} (${dungeon.rooms?.length || 0} rooms)</p>
                    
                    ${roomList ? `
                        <p><strong>Rooms:</strong></p>
                        <ul>${roomList}</ul>
                    ` : ''}
                    
                    ${dungeon.specialFeatures && dungeon.specialFeatures.length > 0 ? `
                        <p><strong>Special Features:</strong> ${dungeon.specialFeatures.join(', ')}</p>
                    ` : ''}
                </div>
            `;
        }

        function displayWeather(weather) {
            if (!weather || weather.length === 0) return '';
            
            const weatherList = weather.map(day => `
                <li><strong>Day ${day.day}:</strong> ${day.text || day.condition || 'Clear'} 
                    ${day.temperature ? `(${day.temperature})` : ''}
                    ${day.effects ? ` - Effects: ${day.effects.visibility || 'Normal visibility'}, ${day.effects.movement || 'Normal movement'}` : ''}
                </li>
            `).join('');

            return `
                <div class="adventure-section">
                    <h4>üå§Ô∏è Weather Progression</h4>
                    <ul>${weatherList}</ul>
                </div>
            `;
        }

        function displayRewards(rewards) {
            if (!rewards) return '';
            
            return `
                <div class="adventure-section">
                    <h4>üèÜ Adventure Rewards</h4>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${rewards.experience?.total || 0}</div>
                            <div class="stat-label">Total XP</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${rewards.experience?.perCharacter || 0}</div>
                            <div class="stat-label">XP per Character</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${rewards.treasure?.gold || 0}</div>
                            <div class="stat-label">Gold Pieces</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${rewards.treasure?.magical || 0}</div>
                            <div class="stat-label">Magic Items</div>
                        </div>
                    </div>

                    ${rewards.experience ? `
                        <p><strong>Experience Breakdown:</strong></p>
                        <ul>
                            <li>Combat XP: ${rewards.experience.combat || 0}</li>
                            <li>Story XP: ${rewards.experience.story || 0}</li>
                            <li>Total XP: ${rewards.experience.total || 0}</li>
                        </ul>
                    ` : ''}

                    ${rewards.reputation ? `
                        <p><strong>Reputation:</strong> ${rewards.reputation.local || 0} local, ${rewards.reputation.regional || 0} regional</p>
                    ` : ''}
                </div>
            `;
        }

        function displayTimeline(timeline) {
            if (!timeline || timeline.length === 0) return '';
            
            const timelineList = timeline.map(event => `
                <li><strong>Day ${event.day}:</strong> ${event.event} - ${event.description}</li>
            `).join('');

            return `
                <div class="adventure-section">
                    <h4>üìÖ Adventure Timeline</h4>
                    <ul>${timelineList}</ul>
                </div>
            `;
        }

        function displayEncounterOnly(encounter) {
            const resultsDiv = document.getElementById('adventureResults');
            
            resultsDiv.innerHTML = `
                <div class="adventure-section">
                    <h4>‚öîÔ∏è ${encounter.title}</h4>
                    <div class="encounter-card">
                        <div class="encounter-header">
                            <h5>${encounter.encounter.type} Encounter</h5>
                            <span class="encounter-difficulty">${encounter.encounter.difficulty}</span>
                        </div>
                        <p><strong>Location:</strong> ${encounter.encounter.location}</p>
                        <p><strong>Trigger:</strong> ${encounter.encounter.trigger}</p>
                        
                        ${encounter.encounter.details ? displayEncounterDetails(encounter.encounter.details, encounter.encounter.type) : ''}
                    </div>
                    <p><strong>Generated:</strong> ${encounter.generated.toLocaleString()}</p>
                </div>
            `;
        }

        // === Action Functions ===
        function exportAdventure() {
            if (!currentAdventure) {
                showError('No adventure to export');
                return;
            }

            try {
                const exportData = JSON.stringify(currentAdventure, null, 2);
                const blob = new Blob([exportData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentAdventure.title.replace(/\s+/g, '-')}-adventure.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showSuccess('Adventure exported successfully!');
            } catch (error) {
                showError('Failed to export adventure: ' + error.message);
            }
        }

        function saveAdventure() {
            if (!currentAdventure) {
                showError('No adventure to save');
                return;
            }

            try {
                const savedAdventures = JSON.parse(localStorage.getItem('rulzlawyer_adventures') || '[]');
                savedAdventures.push({
                    ...currentAdventure,
                    savedAt: new Date()
                });
                localStorage.setItem('rulzlawyer_adventures', JSON.stringify(savedAdventures));
                
                showSuccess('Adventure saved successfully!');
            } catch (error) {
                showError('Failed to save adventure: ' + error.message);
            }
        }

        function clearResults() {
            document.getElementById('adventureResults').innerHTML = `
                <div id="welcomeMessage">
                    <div class="adventure-section">
                        <h4>üé≤ Adventure Engine Ready</h4>
                        <p>Configure your parameters and generate a new adventure!</p>
                    </div>
                </div>
            `;
            currentAdventure = null;
            clearMessages();
        }

        // === Utility Functions ===
        function showLoading(show) {
            const loading = document.getElementById('loadingIndicator');
            if (loading) {
                loading.style.display = show ? 'block' : 'none';
            }
            
            if (show) {
                document.getElementById('welcomeMessage')?.remove();
            }
        }

        function showSuccess(message) {
            removeExistingMessages();
            const resultsDiv = document.getElementById('adventureResults');
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            resultsDiv.insertBefore(successDiv, resultsDiv.firstChild);
            
            setTimeout(() => successDiv.remove(), 5000);
        }

        function showError(message) {
            removeExistingMessages();
            const resultsDiv = document.getElementById('adventureResults');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            resultsDiv.insertBefore(errorDiv, resultsDiv.firstChild);
        }

        function clearMessages() {
            removeExistingMessages();
        }

        function removeExistingMessages() {
            document.querySelectorAll('.success, .error').forEach(el => el.remove());
        }

        function updateStatistics() {
            if (window.adventureEngine) {
                const stats = window.adventureEngine.getStatistics();
                document.getElementById('adventuresGenerated').textContent = stats.adventuresGenerated || 0;
                adventureStats = stats;
            } else {
                adventureStats.generated++;
                document.getElementById('adventuresGenerated').textContent = adventureStats.generated;
            }
        }

        function initializeFallbackMode() {
            console.log('üîß Initializing fallback mode for Adventure Engine');
            // Fallback mode provides basic functionality when full engine isn't available
        }

        // === Fallback Generation Functions ===
        function generateFallbackAdventure(parameters) {
            const adventureTypes = ['investigation', 'dungeon', 'rescue', 'exploration'];
            const type = parameters.type || adventureTypes[Math.floor(Math.random() * adventureTypes.length)];
            
            return {
                id: `fallback_${Date.now()}`,
                title: generateFallbackTitle(),
                type: type,
                partyLevel: parameters.partyLevel,
                partySize: parameters.partySize,
                difficulty: parameters.difficulty,
                estimatedDuration: { sessions: 3, hours: 12 },
                hook: {
                    text: 'A mysterious quest awaits the brave adventurers...',
                    urgency: 'moderate',
                    reward: `${parameters.partyLevel * 100} gold pieces`
                },
                encounters: [
                    {
                        type: 'combat',
                        difficulty: parameters.difficulty,
                        location: 'Forest clearing',
                        trigger: 'Party encounters bandits',
                        details: {
                            creatures: [
                                {
                                    name: 'Bandit',
                                    cr: Math.max(1, parameters.partyLevel - 1),
                                    xp: 300,
                                    quantity: Math.min(4, parameters.partySize)
                                }
                            ],
                            totalXP: 300 * Math.min(4, parameters.partySize)
                        }
                    }
                ],
                treasures: [
                    {
                        text: `${parameters.partyLevel * 50} gold pieces and a magic scroll`,
                        location: 'Hidden chest',
                        protection: 'Simple lock'
                    }
                ],
                rewards: {
                    experience: {
                        total: 300 * Math.min(4, parameters.partySize),
                        perCharacter: Math.floor((300 * Math.min(4, parameters.partySize)) / parameters.partySize)
                    },
                    treasure: {
                        gold: parameters.partyLevel * 100,
                        items: 1,
                        magical: 1
                    }
                },
                created: new Date()
            };
        }

        function generateFallbackEncounter(parameters) {
            return {
                title: 'Random Encounter',
                encounter: {
                    type: 'combat',
                    difficulty: parameters.difficulty || 'medium',
                    location: 'Wilderness area',
                    trigger: 'Random encounter',
                    details: {
                        creatures: [
                            {
                                name: 'Wild Animal',
                                cr: parameters.partyLevel || 1,
                                xp: 300,
                                quantity: 1
                            }
                        ],
                        totalXP: 300
                    }
                },
                generated: new Date()
            };
        }

        function generateFallbackTitle() {
            const prefixes = ['The Quest for', 'Mystery of', 'The Lost', 'Shadow of'];
            const suffixes = ['the Ancient Temple', 'the Crimson Crown', 'the Whispering Woods', 'the Iron Tower'];
            
            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
            
            return `${prefix} ${suffix}`;
        }

        // Global functions for onclick handlers
        window.generateAdventure = generateAdventure;
        window.generateQuickAdventure = generateQuickAdventure;
        window.generateEncounter = generateEncounter;
        window.exportAdventure = exportAdventure;
        window.saveAdventure = saveAdventure;
        window.clearResults = clearResults;
    </script>
</body>
</html>