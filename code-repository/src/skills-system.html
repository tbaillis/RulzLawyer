<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RulzLawyer - Skills System</title>
    <style>
        /* Core Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cinzel', 'Times New Roman', serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e8e8e8;
            min-height: 100vh;
            background-attachment: fixed;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2c1810 0%, #8B4513 50%, #D2B48C 100%);
            padding: 1rem 2rem;
            border-bottom: 3px solid #DAA520;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .header h1 {
            color: #DAA520;
            text-align: center;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 0.5rem;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .nav-btn {
            background: linear-gradient(135deg, #8B4513, #A0522D);
            color: #DAA520;
            padding: 0.5rem 1rem;
            border: 2px solid #DAA520;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #A0522D, #CD853F);
            color: #FFF;
            box-shadow: 0 2px 5px rgba(218, 165, 32, 0.3);
        }

        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Character Integration Panel */
        .character-panel {
            background: linear-gradient(135deg, #2c1810, #3d2414);
            border: 2px solid #8B4513;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .character-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 2rem;
            margin-bottom: 1rem;
        }

        .stat-group h3 {
            color: #DAA520;
            border-bottom: 2px solid #8B4513;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .skill-points-display {
            background: rgba(139, 69, 19, 0.2);
            padding: 1rem;
            border-radius: 5px;
            border: 1px solid #8B4513;
        }

        .skill-points-display .points {
            font-size: 1.5em;
            font-weight: bold;
            color: #DAA520;
        }

        /* Skills Management */
        .skills-section {
            background: linear-gradient(135deg, #2c1810, #3d2414);
            border: 2px solid #8B4513;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .section-title {
            color: #DAA520;
            font-size: 2em;
            text-align: center;
            margin-bottom: 2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* Filters and Search */
        .filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(139, 69, 19, 0.1);
            border-radius: 5px;
            border: 1px solid #8B4513;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem;
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #8B4513;
            border-radius: 5px;
            color: #e8e8e8;
            font-size: 1rem;
        }

        .filter-select {
            padding: 0.5rem;
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #8B4513;
            border-radius: 5px;
            color: #e8e8e8;
            min-width: 150px;
        }

        /* Skills Grid */
        .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .skill-card {
            background: linear-gradient(135deg, rgba(40, 40, 40, 0.9), rgba(60, 60, 60, 0.7));
            border: 2px solid #8B4513;
            border-radius: 10px;
            padding: 1.5rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .skill-card:hover {
            border-color: #DAA520;
            box-shadow: 0 4px 12px rgba(218, 165, 32, 0.2);
            transform: translateY(-2px);
        }

        .skill-card.class-skill {
            border-left: 4px solid #DAA520;
        }

        .skill-card.cross-class-skill {
            border-left: 4px solid #CD853F;
        }

        .skill-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .skill-name {
            color: #DAA520;
            font-size: 1.3em;
            font-weight: bold;
        }

        .skill-type {
            background: rgba(139, 69, 19, 0.8);
            color: #DAA520;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8em;
        }

        .skill-ability {
            color: #CD853F;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .skill-description {
            color: #e8e8e8;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .skill-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(139, 69, 19, 0.1);
            border-radius: 5px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #DAA520;
        }

        .stat-label {
            font-size: 0.8em;
            color: #CD853F;
        }

        /* Skill Advancement */
        .skill-advancement {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .rank-input {
            width: 60px;
            padding: 0.3rem;
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #8B4513;
            border-radius: 3px;
            color: #e8e8e8;
            text-align: center;
        }

        .advance-btn {
            background: linear-gradient(135deg, #8B4513, #A0522D);
            color: #DAA520;
            padding: 0.3rem 0.8rem;
            border: 1px solid #DAA520;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .advance-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #A0522D, #CD853F);
            color: #FFF;
        }

        .advance-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .cost-display {
            color: #CD853F;
            font-size: 0.9em;
        }

        /* Skill Check Interface */
        .skill-check-section {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(139, 69, 19, 0.1);
            border-radius: 5px;
            border: 1px solid #8B4513;
        }

        .check-inputs {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .dc-input {
            width: 80px;
            padding: 0.3rem;
            background: rgba(40, 40, 40, 0.8);
            border: 1px solid #8B4513;
            border-radius: 3px;
            color: #e8e8e8;
            text-align: center;
        }

        .roll-btn {
            background: linear-gradient(135deg, #4169E1, #0000CD);
            color: #FFF;
            padding: 0.5rem 1rem;
            border: 1px solid #DAA520;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .roll-btn:hover {
            background: linear-gradient(135deg, #0000CD, #191970);
            box-shadow: 0 2px 5px rgba(65, 105, 225, 0.3);
        }

        .check-result {
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            font-weight: bold;
        }

        .check-result.success {
            background: rgba(34, 139, 34, 0.2);
            border: 1px solid #228B22;
            color: #90EE90;
        }

        .check-result.failure {
            background: rgba(139, 34, 34, 0.2);
            border: 1px solid #8B2222;
            color: #FFA0A0;
        }

        /* Synergy Display */
        .synergy-bonuses {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(139, 69, 19, 0.1);
            border-radius: 5px;
            border: 1px solid #8B4513;
        }

        .synergy-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0.3rem;
            background: rgba(40, 40, 40, 0.5);
            border-radius: 3px;
        }

        .synergy-source {
            color: #CD853F;
        }

        .synergy-bonus {
            color: #DAA520;
            font-weight: bold;
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #2c1810, #3d2414);
            border: 3px solid #8B4513;
            border-radius: 15px;
            padding: 2rem;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #DAA520;
            font-size: 2em;
            cursor: pointer;
            padding: 0.2rem;
        }

        .modal-title {
            color: #DAA520;
            font-size: 2em;
            margin-bottom: 1rem;
            text-align: center;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .character-info {
                grid-template-columns: 1fr;
            }
            
            .skills-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-bar {
                flex-direction: column;
            }
            
            .search-input, .filter-select {
                min-width: auto;
            }
        }

        /* Animations */
        @keyframes rollDice {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }

        .rolling {
            animation: rollDice 1s ease-in-out;
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid #DAA520;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎲 RulzLawyer Skills System 📚</h1>
        <div class="nav-buttons">
            <a href="index.html" class="nav-btn">🏠 Main Menu</a>
            <a href="character-creator.html" class="nav-btn">👤 Character Creator</a>
            <a href="feats-system.html" class="nav-btn">⚔️ Feats</a>
            <a href="spells-system.html" class="nav-btn">🧙 Spells</a>
            <a href="equipment-system.html" class="nav-btn">⚔️ Equipment</a>
            <a href="holdings-system.html" class="nav-btn">🏰 Holdings</a>
        </div>
    </div>

    <div class="container">
        <!-- Character Integration Panel -->
        <div class="character-panel">
            <div class="character-info">
                <div class="stat-group">
                    <h3>Character Info</h3>
                    <div id="character-name">No Character Loaded</div>
                    <div id="character-level">Level: --</div>
                    <div id="character-classes">Classes: --</div>
                </div>
                
                <div class="stat-group">
                    <h3>Skill Points</h3>
                    <div class="skill-points-display">
                        <div>Available: <span id="available-points" class="points">--</span></div>
                        <div>Spent: <span id="spent-points" class="points">--</span></div>
                        <div>Total: <span id="total-points" class="points">--</span></div>
                    </div>
                </div>
                
                <div class="stat-group">
                    <h3>Skills Summary</h3>
                    <div>Class Skills: <span id="class-skills-count">--</span></div>
                    <div>Cross-Class: <span id="cross-class-count">--</span></div>
                    <div>Total Trained: <span id="trained-skills-count">--</span></div>
                </div>
            </div>
        </div>

        <!-- Skills Management Section -->
        <div class="skills-section">
            <h2 class="section-title">D&D 3.5 Skills Management</h2>
            
            <!-- Filter and Search Bar -->
            <div class="filter-bar">
                <input type="text" id="skill-search" class="search-input" placeholder="Search skills...">
                <select id="category-filter" class="filter-select">
                    <option value="all">All Categories</option>
                    <option value="Physical">Physical</option>
                    <option value="Mental">Mental</option>
                    <option value="Social">Social</option>
                    <option value="Stealth">Stealth</option>
                    <option value="Survival">Survival</option>
                    <option value="Perception">Perception</option>
                    <option value="Craft">Craft</option>
                </select>
                <select id="ability-filter" class="filter-select">
                    <option value="all">All Abilities</option>
                    <option value="Strength">Strength</option>
                    <option value="Dexterity">Dexterity</option>
                    <option value="Constitution">Constitution</option>
                    <option value="Intelligence">Intelligence</option>
                    <option value="Wisdom">Wisdom</option>
                    <option value="Charisma">Charisma</option>
                </select>
                <select id="training-filter" class="filter-select">
                    <option value="all">All Skills</option>
                    <option value="trained">Trained Only</option>
                    <option value="class">Class Skills</option>
                    <option value="cross-class">Cross-Class</option>
                </select>
            </div>

            <!-- Skills Grid -->
            <div id="skills-grid" class="skills-grid">
                <!-- Skills will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Skill Detail Modal -->
    <div id="skill-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeSkillModal()">&times;</button>
            <h2 id="modal-skill-name" class="modal-title"></h2>
            <div id="modal-skill-content">
                <!-- Detailed skill information will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let skillsSystem = null;
        let characterDataModel = null;
        let currentCharacter = null;
        let diceEngine = null;

        // Initialize the Skills System
        function initializeSkillsSystem() {
            try {
                console.log('🎲 Initializing Skills System...');
                
                // Create dependencies with mock fallbacks
                const dependencies = {
                    characterDataModel: window.CharacterDataModel || { 
                        getCurrentCharacter: () => null,
                        saveCharacter: () => {},
                        loadCharacter: () => null
                    },
                    diceEngine: window.DiceEngine || {
                        rollDice: (expression) => ({ 
                            total: Math.floor(Math.random() * 20) + 1,
                            rolls: [Math.floor(Math.random() * 20) + 1],
                            expression: expression
                        })
                    }
                };

                // Initialize Skills System
                skillsSystem = new SkillsSystem(dependencies);
                characterDataModel = dependencies.characterDataModel;
                diceEngine = dependencies.diceEngine;
                
                // Load current character
                loadCurrentCharacter();
                
                // Initialize UI
                initializeUI();
                
                console.log('✅ Skills System initialized successfully');
                
            } catch (error) {
                console.error('❌ Error initializing Skills System:', error);
                showErrorMessage('Failed to initialize Skills System. Using mock data.');
                initializeMockSystem();
            }
        }

        function initializeMockSystem() {
            skillsSystem = SkillsSystem.createMockSystem();
            currentCharacter = createMockCharacter();
            initializeUI();
        }

        function createMockCharacter() {
            return {
                name: "Test Character",
                level: 5,
                classes: [{ name: "Fighter", level: 3 }, { name: "Rogue", level: 2 }],
                abilities: {
                    Strength: 16,
                    Dexterity: 14,
                    Constitution: 15,
                    Intelligence: 12,
                    Wisdom: 13,
                    Charisma: 10
                },
                skills: {
                    climb: { ranks: 5, modifier: 0 },
                    hide: { ranks: 3, modifier: 0 },
                    search: { ranks: 4, modifier: 0 },
                    listen: { ranks: 2, modifier: 0 }
                },
                wealth: { gold: 1000 }
            };
        }

        function loadCurrentCharacter() {
            try {
                currentCharacter = characterDataModel.getCurrentCharacter() || createMockCharacter();
                updateCharacterDisplay();
            } catch (error) {
                console.error('Error loading character:', error);
                currentCharacter = createMockCharacter();
                updateCharacterDisplay();
            }
        }

        function initializeUI() {
            displaySkills();
            setupEventListeners();
            updateSkillPointsDisplay();
        }

        function setupEventListeners() {
            // Search and filter functionality
            const searchInput = document.getElementById('skill-search');
            const categoryFilter = document.getElementById('category-filter');
            const abilityFilter = document.getElementById('ability-filter');
            const trainingFilter = document.getElementById('training-filter');

            if (searchInput) searchInput.addEventListener('input', filterSkills);
            if (categoryFilter) categoryFilter.addEventListener('change', filterSkills);
            if (abilityFilter) abilityFilter.addEventListener('change', filterSkills);
            if (trainingFilter) trainingFilter.addEventListener('change', filterSkills);
        }

        function updateCharacterDisplay() {
            const nameElement = document.getElementById('character-name');
            const levelElement = document.getElementById('character-level');
            const classesElement = document.getElementById('character-classes');

            if (nameElement) nameElement.textContent = currentCharacter?.name || 'No Character';
            if (levelElement) {
                const totalLevel = currentCharacter?.classes?.reduce((sum, cls) => sum + cls.level, 0) || 0;
                levelElement.textContent = `Level: ${totalLevel}`;
            }
            if (classesElement) {
                const classStr = currentCharacter?.classes?.map(cls => `${cls.name} ${cls.level}`).join(', ') || 'None';
                classesElement.textContent = `Classes: ${classStr}`;
            }
        }

        function updateSkillPointsDisplay() {
            if (!skillsSystem || !currentCharacter) return;

            try {
                const skillPoints = skillsSystem.calculateSkillPoints(currentCharacter);
                
                const availableElement = document.getElementById('available-points');
                const spentElement = document.getElementById('spent-points');
                const totalElement = document.getElementById('total-points');

                if (availableElement) availableElement.textContent = skillPoints.remaining || 0;
                if (spentElement) spentElement.textContent = skillPoints.spent || 0;
                if (totalElement) totalElement.textContent = skillPoints.totalAvailable || 0;

                // Update skills summary
                const summary = skillsSystem.getCharacterSkillSummary(currentCharacter);
                const classSkillsElement = document.getElementById('class-skills-count');
                const crossClassElement = document.getElementById('cross-class-count');
                const trainedElement = document.getElementById('trained-skills-count');

                if (classSkillsElement) classSkillsElement.textContent = summary.classSkills?.length || 0;
                if (crossClassElement) crossClassElement.textContent = summary.crossClassSkills?.length || 0;
                if (trainedElement) trainedElement.textContent = summary.totalSkills || 0;

            } catch (error) {
                console.error('Error updating skill points display:', error);
            }
        }

        function displaySkills() {
            const skillsGrid = document.getElementById('skills-grid');
            if (!skillsGrid || !skillsSystem) return;

            try {
                const allSkills = skillsSystem.getAllSkills();
                const skillsByCategory = skillsSystem.getSkillsByCategory();
                
                skillsGrid.innerHTML = '';

                // Create skill cards
                Object.values(allSkills).forEach(skill => {
                    const skillCard = createSkillCard(skill);
                    skillsGrid.appendChild(skillCard);
                });

            } catch (error) {
                console.error('Error displaying skills:', error);
                skillsGrid.innerHTML = '<div class="error">Error loading skills</div>';
            }
        }

        function createSkillCard(skill) {
            const isClassSkill = skillsSystem.isClassSkill(skill.id, currentCharacter);
            const characterSkill = currentCharacter?.skills?.[skill.id] || { ranks: 0, modifier: 0 };
            const totalModifier = skillsSystem.calculateSkillModifier(currentCharacter, skill.id);
            const synergyBonus = skillsSystem.calculateSynergyBonus(currentCharacter, skill.id);

            const card = document.createElement('div');
            card.className = `skill-card ${isClassSkill ? 'class-skill' : 'cross-class-skill'}`;
            card.setAttribute('data-skill-id', skill.id);
            card.setAttribute('data-category', getCategoryForSkill(skill.id));
            card.setAttribute('data-ability', skill.keyAbility);

            card.innerHTML = `
                <div class="skill-header">
                    <div class="skill-name">${skill.name}</div>
                    <div class="skill-type">${isClassSkill ? 'Class' : 'Cross-Class'}</div>
                </div>
                
                <div class="skill-ability">Key Ability: ${skill.keyAbility}</div>
                <div class="skill-description">${skill.description}</div>
                
                <div class="skill-stats">
                    <div class="stat">
                        <div class="stat-value">${characterSkill.ranks}</div>
                        <div class="stat-label">Ranks</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${totalModifier >= 0 ? '+' : ''}${totalModifier}</div>
                        <div class="stat-label">Total Mod</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">${synergyBonus > 0 ? '+' + synergyBonus : '0'}</div>
                        <div class="stat-label">Synergy</div>
                    </div>
                </div>

                <div class="skill-advancement">
                    <label>Ranks:</label>
                    <input type="number" class="rank-input" value="${characterSkill.ranks}" 
                           min="0" max="${getMaxRanks(skill.id, currentCharacter)}"
                           onchange="updateSkillRanks('${skill.id}', this.value)">
                    <button class="advance-btn" onclick="advanceSkill('${skill.id}')">Advance</button>
                    <span class="cost-display">Cost: ${isClassSkill ? '1' : '2'} points</span>
                </div>

                <div class="skill-check-section">
                    <div class="check-inputs">
                        <label>DC:</label>
                        <input type="number" class="dc-input" value="15" id="dc-${skill.id}">
                        <button class="roll-btn" onclick="makeSkillCheck('${skill.id}')">
                            🎲 Roll Check
                        </button>
                    </div>
                    <div id="result-${skill.id}" class="check-result" style="display: none;"></div>
                </div>

                ${synergyBonus > 0 ? `
                    <div class="synergy-bonuses">
                        <strong>Synergy Bonuses:</strong>
                        <div class="synergy-item">
                            <span class="synergy-source">From other skills</span>
                            <span class="synergy-bonus">+${synergyBonus}</span>
                        </div>
                    </div>
                ` : ''}

                <button onclick="showSkillDetails('${skill.id}')" class="nav-btn" style="margin-top: 1rem; width: 100%;">
                    📖 View Details
                </button>
            `;

            return card;
        }

        function getCategoryForSkill(skillId) {
            const categories = skillsSystem.getSkillsByCategory();
            for (const [category, skills] of Object.entries(categories)) {
                if (skills.includes(skillId)) {
                    return category;
                }
            }
            return 'Other';
        }

        function getMaxRanks(skillId, character) {
            const characterLevel = character?.classes?.reduce((sum, cls) => sum + cls.level, 0) || 1;
            const isClassSkill = skillsSystem.isClassSkill(skillId, character);
            return isClassSkill ? (characterLevel + 3) : Math.floor((characterLevel + 3) / 2);
        }

        function updateSkillRanks(skillId, newRanks) {
            if (!currentCharacter || !skillsSystem) return;

            try {
                const ranks = parseInt(newRanks) || 0;
                const validation = skillsSystem.canAdvanceSkill(currentCharacter, skillId, ranks);
                
                if (!validation.valid) {
                    alert(validation.reason);
                    // Reset the input to current value
                    const input = document.querySelector(`[data-skill-id="${skillId}"] .rank-input`);
                    if (input) {
                        const currentSkill = currentCharacter.skills?.[skillId] || { ranks: 0 };
                        input.value = currentSkill.ranks;
                    }
                    return;
                }

                // Update skill ranks
                skillsSystem.advanceSkill(currentCharacter, skillId, ranks);
                
                // Refresh displays
                updateSkillPointsDisplay();
                displaySkills();
                
                console.log(`Updated ${skillId} to ${ranks} ranks`);

            } catch (error) {
                console.error('Error updating skill ranks:', error);
                alert('Error updating skill: ' + error.message);
            }
        }

        function advanceSkill(skillId) {
            const input = document.querySelector(`[data-skill-id="${skillId}"] .rank-input`);
            if (!input) return;

            const currentRanks = parseInt(input.value) || 0;
            const newRanks = currentRanks + 1;
            
            input.value = newRanks;
            updateSkillRanks(skillId, newRanks);
        }

        function makeSkillCheck(skillId) {
            if (!skillsSystem || !currentCharacter) return;

            try {
                const dcInput = document.getElementById(`dc-${skillId}`);
                const resultDiv = document.getElementById(`result-${skillId}`);
                const rollBtn = document.querySelector(`[data-skill-id="${skillId}"] .roll-btn`);

                if (!dcInput || !resultDiv) return;

                const dc = parseInt(dcInput.value) || 15;

                // Add rolling animation
                rollBtn.classList.add('rolling');
                
                setTimeout(() => {
                    const result = skillsSystem.makeSkillCheck(currentCharacter, skillId, dc);
                    
                    resultDiv.style.display = 'block';
                    resultDiv.className = `check-result ${result.success ? 'success' : 'failure'}`;
                    
                    const breakdown = result.breakdown || {};
                    resultDiv.innerHTML = `
                        <div><strong>${result.success ? '✅ SUCCESS' : '❌ FAILURE'}</strong></div>
                        <div>Roll: ${result.roll} + ${result.modifier} = ${result.total} vs DC ${dc}</div>
                        <div style="font-size: 0.9em; margin-top: 0.5rem;">
                            Breakdown: ${result.roll} (roll) + ${breakdown.abilityModifier || 0} (ability) + 
                            ${breakdown.ranks || 0} (ranks) + ${breakdown.synergy || 0} (synergy) + 
                            ${breakdown.miscModifier || 0} (misc)
                        </div>
                    `;

                    rollBtn.classList.remove('rolling');
                }, 1000);

            } catch (error) {
                console.error('Error making skill check:', error);
                alert('Error making skill check: ' + error.message);
            }
        }

        function showSkillDetails(skillId) {
            const skill = skillsSystem.getSkillInfo(skillId);
            if (!skill) return;

            const modal = document.getElementById('skill-modal');
            const modalTitle = document.getElementById('modal-skill-name');
            const modalContent = document.getElementById('modal-skill-content');

            modalTitle.textContent = skill.name;
            
            const dcExamples = Object.entries(skill.dcExamples || {})
                .map(([dc, desc]) => `<li>DC ${dc}: ${desc}</li>`)
                .join('');

            modalContent.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: #DAA520; margin-bottom: 1rem;">Skill Information</h3>
                    <p><strong>Key Ability:</strong> ${skill.keyAbility}</p>
                    <p><strong>Trained Only:</strong> ${skill.trainedOnly ? 'Yes' : 'No'}</p>
                    <p><strong>Armor Check Penalty:</strong> ${skill.armorCheckPenalty ? 'Yes' : 'No'}</p>
                    <p><strong>Description:</strong> ${skill.description}</p>
                </div>

                ${skill.untrained ? `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #DAA520; margin-bottom: 1rem;">Untrained Use</h3>
                        <p>${skill.untrained}</p>
                    </div>
                ` : ''}

                <div style="margin-bottom: 2rem;">
                    <h3 style="color: #DAA520; margin-bottom: 1rem;">Check</h3>
                    <p>${skill.check}</p>
                </div>

                <div style="margin-bottom: 2rem;">
                    <h3 style="color: #DAA520; margin-bottom: 1rem;">Retry</h3>
                    <p>${skill.retry}</p>
                </div>

                ${skill.special ? `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #DAA520; margin-bottom: 1rem;">Special</h3>
                        <p>${skill.special}</p>
                    </div>
                ` : ''}

                ${dcExamples ? `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #DAA520; margin-bottom: 1rem;">Example DCs</h3>
                        <ul style="color: #e8e8e8; padding-left: 2rem;">
                            ${dcExamples}
                        </ul>
                    </div>
                ` : ''}
            `;

            modal.style.display = 'flex';
        }

        function closeSkillModal() {
            const modal = document.getElementById('skill-modal');
            modal.style.display = 'none';
        }

        function filterSkills() {
            const searchTerm = document.getElementById('skill-search')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('category-filter')?.value || 'all';
            const abilityFilter = document.getElementById('ability-filter')?.value || 'all';
            const trainingFilter = document.getElementById('training-filter')?.value || 'all';

            const skillCards = document.querySelectorAll('.skill-card');
            
            skillCards.forEach(card => {
                const skillId = card.getAttribute('data-skill-id');
                const category = card.getAttribute('data-category');
                const ability = card.getAttribute('data-ability');
                const skillName = card.querySelector('.skill-name')?.textContent.toLowerCase() || '';
                const skillDescription = card.querySelector('.skill-description')?.textContent.toLowerCase() || '';

                let show = true;

                // Search filter
                if (searchTerm && !skillName.includes(searchTerm) && !skillDescription.includes(searchTerm)) {
                    show = false;
                }

                // Category filter
                if (categoryFilter !== 'all' && category !== categoryFilter) {
                    show = false;
                }

                // Ability filter
                if (abilityFilter !== 'all' && ability !== abilityFilter) {
                    show = false;
                }

                // Training filter
                if (trainingFilter !== 'all') {
                    const isClassSkill = card.classList.contains('class-skill');
                    const characterSkill = currentCharacter?.skills?.[skillId];
                    const isTrained = characterSkill && characterSkill.ranks > 0;

                    if (trainingFilter === 'trained' && !isTrained) show = false;
                    if (trainingFilter === 'class' && !isClassSkill) show = false;
                    if (trainingFilter === 'cross-class' && isClassSkill) show = false;
                }

                card.style.display = show ? 'block' : 'none';
            });
        }

        function showErrorMessage(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.style.cssText = `
                background: rgba(139, 34, 34, 0.2);
                border: 2px solid #8B2222;
                color: #FFA0A0;
                padding: 1rem;
                border-radius: 5px;
                margin-bottom: 2rem;
                text-align: center;
            `;
            errorDiv.innerHTML = `<strong>⚠️ ${message}</strong>`;
            
            if (container) {
                container.insertBefore(errorDiv, container.firstChild);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('skill-modal');
            if (event.target === modal) {
                closeSkillModal();
            }
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎲 Skills System page loaded, initializing...');
            initializeSkillsSystem();
        });

        // Make functions globally accessible
        window.makeSkillCheck = makeSkillCheck;
        window.showSkillDetails = showSkillDetails;
        window.closeSkillModal = closeSkillModal;
        window.updateSkillRanks = updateSkillRanks;
        window.advanceSkill = advanceSkill;
    </script>
</body>
</html>