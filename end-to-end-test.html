<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RulzLawyer End-to-End Test</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: #e8e6e3;
            margin: 0;
            padding: 20px;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .test-panel {
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid #d4af37;
        }
        .test-button {
            background: linear-gradient(135deg, #4a9eff, #0066cc);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            background: linear-gradient(135deg, #66b3ff, #0080ff);
            transform: translateY(-1px);
        }
        .test-button.success { background: linear-gradient(135deg, #28a745, #20c997); }
        .test-button.warning { background: linear-gradient(135deg, #ffc107, #e0a800); color: #000; }
        .test-output {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #444;
        }
        .app-frame {
            width: 100%;
            height: 600px;
            border: 2px solid #d4af37;
            border-radius: 8px;
        }
        .status-ok { color: #4CAF50; }
        .status-error { color: #f44336; }
        .status-warning { color: #ff9800; }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-panel">
            <h2>üéØ End-to-End Character Creation Test</h2>
            
            <div style="margin: 20px 0;">
                <h3>Automated Workflow Tests</h3>
                <button class="test-button" onclick="testCompleteCharacterWorkflow()">Complete Character Creation</button>
                <button class="test-button" onclick="testDiceRollingWorkflow()">Complete Dice Rolling</button>
                <button class="test-button" onclick="testCharacterEditingWorkflow()">Character Editing Workflow</button>
                <button class="test-button success" onclick="runAllEndToEndTests()">Run All E2E Tests</button>
            </div>

            <div style="margin: 20px 0;">
                <h3>Manual Testing Steps</h3>
                <button class="test-button warning" onclick="step1_OpenCharacterCreation()">Step 1: Open Character Creation</button>
                <button class="test-button warning" onclick="step2_FillCharacterForm()">Step 2: Fill Character Form</button>
                <button class="test-button warning" onclick="step3_SubmitCharacter()">Step 3: Submit Character</button>
                <button class="test-button warning" onclick="step4_SelectCharacter()">Step 4: Select Character</button>
                <button class="test-button warning" onclick="step5_EditCharacter()">Step 5: Edit Character</button>
                <button class="test-button warning" onclick="step6_TestDiceRolling()">Step 6: Test Dice Rolling</button>
            </div>

            <div id="e2e-output" class="test-output">
                End-to-End Testing Console Ready...
                Click buttons above to test complete user workflows.
            </div>
        </div>

        <div class="test-panel">
            <h2>üéÆ Live Application</h2>
            <iframe id="app-frame" class="app-frame" src="http://localhost:3000"></iframe>
            
            <div style="margin: 20px 0;">
                <h3>Workflow Status</h3>
                <div id="workflow-status" class="test-output">
                    Workflow tracking initialized. Start tests to see progress.
                </div>
            </div>
        </div>
    </div>

    <script>
        let workflowState = {
            characterCreated: false,
            characterSelected: false,
            characterEdited: false,
            diceRolled: false,
            currentCharacterId: null
        };

        function log(message, type = 'info', targetId = 'e2e-output') {
            const timestamp = new Date().toLocaleTimeString();
            const element = document.getElementById(targetId);
            const className = type === 'error' ? 'status-error' : 
                             type === 'warning' ? 'status-warning' : 'status-ok';
            
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        function updateWorkflowStatus() {
            const status = document.getElementById('workflow-status');
            status.innerHTML = `
                <div>Character Created: ${workflowState.characterCreated ? '‚úÖ' : '‚ùå'}</div>
                <div>Character Selected: ${workflowState.characterSelected ? '‚úÖ' : '‚ùå'}</div>
                <div>Character Edited: ${workflowState.characterEdited ? '‚úÖ' : '‚ùå'}</div>
                <div>Dice Rolled: ${workflowState.diceRolled ? '‚úÖ' : '‚ùå'}</div>
                <div>Current Character: ${workflowState.currentCharacterId || 'None'}</div>
            `;
        }

        function getAppFrame() {
            return document.getElementById('app-frame');
        }

        function executeInApp(code, callback) {
            const iframe = getAppFrame();
            try {
                const result = iframe.contentWindow.eval(code);
                callback(null, result);
            } catch (error) {
                callback(error, null);
            }
        }

        // Complete Workflow Tests
        function testCompleteCharacterWorkflow() {
            log('üöÄ Starting complete character creation workflow test...', 'info');
            
            setTimeout(() => {
                // Step 1: Open character creation
                executeInApp(`
                    try {
                        if (typeof window.createNewCharacter === 'function') {
                            window.createNewCharacter();
                            'modal opened';
                        } else {
                            'function not found';
                        }
                    } catch (error) {
                        error.message;
                    }
                `, (error, result) => {
                    if (result === 'modal opened') {
                        log('‚úÖ Step 1: Character creation modal opened', 'info');
                        setTimeout(step2_AutoFillForm, 500);
                    } else {
                        log('‚ùå Step 1 failed: ' + result, 'error');
                    }
                });
            }, 100);
        }

        function step2_AutoFillForm() {
            log('‚öôÔ∏è Step 2: Auto-filling character form...', 'info');
            
            executeInApp(`
                try {
                    const nameInput = document.getElementById('char-name');
                    const raceSelect = document.getElementById('char-race');
                    const classSelect = document.getElementById('char-class');
                    const levelInput = document.getElementById('char-level');
                    
                    if (nameInput) nameInput.value = 'Test Hero E2E';
                    if (raceSelect) raceSelect.value = 'human';
                    if (classSelect) classSelect.value = 'fighter';
                    if (levelInput) levelInput.value = '1';
                    
                    'form filled';
                } catch (error) {
                    error.message;
                }
            `, (error, result) => {
                if (result === 'form filled') {
                    log('‚úÖ Step 2: Character form filled successfully', 'info');
                    setTimeout(step3_AutoSubmit, 500);
                } else {
                    log('‚ùå Step 2 failed: ' + result, 'error');
                }
            });
        }

        function step3_AutoSubmit() {
            log('üì§ Step 3: Submitting character form...', 'info');
            
            executeInApp(`
                try {
                    const form = document.getElementById('character-form');
                    if (form) {
                        const submitEvent = new Event('submit', { cancelable: true });
                        form.dispatchEvent(submitEvent);
                        'form submitted';
                    } else {
                        'form not found';
                    }
                } catch (error) {
                    error.message;
                }
            `, (error, result) => {
                if (result === 'form submitted') {
                    log('‚úÖ Step 3: Character form submitted', 'info');
                    workflowState.characterCreated = true;
                    updateWorkflowStatus();
                    setTimeout(step4_AutoSelectCharacter, 1000);
                } else {
                    log('‚ùå Step 3 failed: ' + result, 'error');
                }
            });
        }

        function step4_AutoSelectCharacter() {
            log('üë§ Step 4: Selecting created character...', 'info');
            
            executeInApp(`
                try {
                    const characterItems = document.querySelectorAll('.character-item');
                    if (characterItems.length > 0) {
                        const firstCharacter = characterItems[0];
                        firstCharacter.click();
                        'character selected';
                    } else {
                        'no characters found';
                    }
                } catch (error) {
                    error.message;
                }
            `, (error, result) => {
                if (result === 'character selected') {
                    log('‚úÖ Step 4: Character selected successfully', 'info');
                    workflowState.characterSelected = true;
                    updateWorkflowStatus();
                    setTimeout(() => {
                        log('üéâ Complete character creation workflow SUCCESS!', 'info');
                    }, 500);
                } else {
                    log('‚ùå Step 4 failed: ' + result, 'error');
                }
            });
        }

        function testDiceRollingWorkflow() {
            log('üé≤ Starting complete dice rolling workflow test...', 'info');
            
            // Test standard dice roll
            executeInApp(`
                try {
                    if (typeof window.rollDice === 'function') {
                        window.rollDice();
                        'dice rolled';
                    } else {
                        'function not found';
                    }
                } catch (error) {
                    error.message;
                }
            `, (error, result) => {
                if (result === 'dice rolled') {
                    log('‚úÖ Standard dice roll successful', 'info');
                    
                    // Test advantage roll
                    setTimeout(() => {
                        executeInApp(`
                            try {
                                if (typeof window.rollAdvantage === 'function') {
                                    window.rollAdvantage();
                                    'advantage rolled';
                                } else {
                                    'function not found';
                                }
                            } catch (error) {
                                error.message;
                            }
                        `, (err, advResult) => {
                            if (advResult === 'advantage rolled') {
                                log('‚úÖ Advantage roll successful', 'info');
                                workflowState.diceRolled = true;
                                updateWorkflowStatus();
                                log('üéâ Complete dice rolling workflow SUCCESS!', 'info');
                            } else {
                                log('‚ùå Advantage roll failed: ' + advResult, 'error');
                            }
                        });
                    }, 500);
                } else {
                    log('‚ùå Standard dice roll failed: ' + result, 'error');
                }
            });
        }

        function testCharacterEditingWorkflow() {
            log('‚úèÔ∏è Starting character editing workflow test...', 'info');
            
            // First ensure we have a character to edit
            executeInApp(`
                try {
                    if (window.gameEngine && window.gameEngine.storageManager) {
                        const characters = window.gameEngine.storageManager.getAllCharacters();
                        if (characters.length > 0) {
                            const charId = characters[0].id;
                            if (typeof window.editCharacter === 'function') {
                                window.editCharacter(charId);
                                charId;
                            } else {
                                'edit function not found';
                            }
                        } else {
                            'no characters found';
                        }
                    } else {
                        'storage manager not found';
                    }
                } catch (error) {
                    error.message;
                }
            `, (error, result) => {
                if (result && result !== 'no characters found' && result !== 'edit function not found' && result !== 'storage manager not found') {
                    log('‚úÖ Character editing modal opened', 'info');
                    workflowState.currentCharacterId = result;
                    workflowState.characterEdited = true;
                    updateWorkflowStatus();
                    log('üéâ Character editing workflow SUCCESS!', 'info');
                } else {
                    log('‚ùå Character editing failed: ' + result, 'error');
                }
            });
        }

        // Manual Testing Steps
        function step1_OpenCharacterCreation() {
            log('üìã Manual Step 1: Opening character creation...', 'warning');
            
            executeInApp(`
                try {
                    if (typeof window.createNewCharacter === 'function') {
                        window.createNewCharacter();
                        'opened';
                    } else {
                        'function not found';
                    }
                } catch (error) {
                    error.message;
                }
            `, (error, result) => {
                if (result === 'opened') {
                    log('‚úÖ Manual Step 1: Character creation modal opened', 'info');
                } else {
                    log('‚ùå Manual Step 1 failed: ' + result, 'error');
                }
            });
        }

        function step2_FillCharacterForm() {
            log('üìù Manual Step 2: Filling character form...', 'warning');
            
            executeInApp(`
                try {
                    const nameInput = document.getElementById('char-name');
                    const raceSelect = document.getElementById('char-race');
                    const classSelect = document.getElementById('char-class');
                    
                    if (nameInput) nameInput.value = 'Manual Test Character';
                    if (raceSelect) raceSelect.value = 'elf';
                    if (classSelect) classSelect.value = 'wizard';
                    
                    'filled';
                } catch (error) {
                    error.message;
                }
            `, (error, result) => {
                if (result === 'filled') {
                    log('‚úÖ Manual Step 2: Form filled with test data', 'info');
                } else {
                    log('‚ùå Manual Step 2 failed: ' + result, 'error');
                }
            });
        }

        function step3_SubmitCharacter() {
            log('‚úÖ Manual Step 3: Submitting character...', 'warning');
            log('üí° Please click the "Create Character" button in the modal', 'warning');
        }

        function step4_SelectCharacter() {
            log('üëÜ Manual Step 4: Selecting character...', 'warning');
            log('üí° Please click on a character in the character list', 'warning');
        }

        function step5_EditCharacter() {
            log('‚úèÔ∏è Manual Step 5: Editing character...', 'warning');
            log('üí° Please click the "Edit" button next to a character', 'warning');
        }

        function step6_TestDiceRolling() {
            log('üé≤ Manual Step 6: Testing dice rolling...', 'warning');
            log('üí° Please click the "ROLL DICE" button or try different dice buttons', 'warning');
        }

        function runAllEndToEndTests() {
            log('üöÄ Running comprehensive end-to-end test suite...', 'info');
            
            // Reset workflow state
            workflowState = {
                characterCreated: false,
                characterSelected: false,
                characterEdited: false,
                diceRolled: false,
                currentCharacterId: null
            };
            updateWorkflowStatus();
            
            // Run tests in sequence
            setTimeout(() => testCompleteCharacterWorkflow(), 500);
            setTimeout(() => testDiceRollingWorkflow(), 3000);
            setTimeout(() => testCharacterEditingWorkflow(), 5000);
            
            setTimeout(() => {
                log('üìä End-to-end test suite completed', 'info');
                const successCount = Object.values(workflowState).filter(v => v === true).length;
                log(`üéØ Results: ${successCount}/4 workflows completed successfully`, 'info');
                
                if (successCount >= 3) {
                    log('üéâ OVERALL SUCCESS: Application UI is fully functional!', 'info');
                } else {
                    log('‚ö†Ô∏è Some workflows failed. Check individual test results.', 'warning');
                }
            }, 7000);
        }

        // Auto-initialize
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('üß™ End-to-End Testing Suite loaded', 'info');
                log('üéØ This suite tests complete user workflows from start to finish', 'info');
                log('üí° Use "Run All E2E Tests" for comprehensive validation', 'info');
                updateWorkflowStatus();
            }, 1000);
        });
    </script>
</body>
</html>